<!DOCTYPE html>
<html>
<body>

  <h1>IoT Endpoint Server</h1>
  <label for="scale">Temperature Scale:</label>
  <select id="scale">
    <option value="F" selected>Fahrenheit</option>
    <option value="C">Celsius</option>
  </select>
  <div id="msg" class="mt">Awaiting IoT Device Report ...</div>
</body>
</html>

<script>
  window.addEventListener('load', (event) => {
    // create websocket connection with IoT device.
    getIt()
  })

  //get data to refresh dashboard
  setInterval( () => {
    getDashboardData()
  }, 1000)

  const getDashboardData = async () => {
    try {
      const response = await fetch('http://localhost:3000/dashboard')
      if(!response.ok){
        throw new Error(`Response status: ${response.status}`)
      }
      const json = await response.json()
      if(json !== null){
        document.getElementById("msg").innerHTML = ("IoT Device Reports: " + json)
      }
    } catch(error) {
      console.log(error)
    }
  }

  const getIt = async () => {
    let iotIp = null;
    let url = ""
    iotIp = (await getIotIp())
    if(iotIp.iotip == null){
      console.log('awaiting IoT registration ...')
      getIt()
    } else {
      url = 'ws://' + iotIp.iotip + ':3000'
      console.log('IoT registered: ', url)
      //const socket = new WebSocket('ws://192.168.1.19:3000'); //iot device
      const socket = new WebSocket(url); //iot device
        socket.addEventListener("open", () => {
          document.getElementById("scale").addEventListener("change", () => {
            //send command to the IoT device to change temperature scale
            const command = {"cmd": "scale", "scale": document.getElementById("scale").value, "ts": Date.now()}
            socket.send(JSON.stringify(command))
          })
        })
        socket.addEventListener('error', () => {
          console.log(event)
        })
    }
    //
  }

  const getIotIp = async () => {
    try {
      const response = await fetch('http://localhost:3000/iot/ip')
      if(!response.ok){
        throw new Error(`Response status: ${response.status}`)
      }
      const json = await response.json()
      return json
    } catch (error){
      console.log(error)
    }
  }

</script>

<style>
  .mt {
    margin-top: 1rem;
  }  
</style>